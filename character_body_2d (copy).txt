extends CharacterBody2D

const SPEED = 300.0
const JUMP_VELOCITY = -500.0
var hitpoints: float = (10)
var hurting: bool = false
var dead: bool = false
var attacking: bool = false
var combotime: float = clampf(0, 0.000000000, 20)
var can_combo: bool = true
var standardcombotime: float = .3333
var shortcombotime: float = 0.08
var longcombotime: float = .5
const framelength: float = 0.1428
#credit to Aruko for getting me to have damage call hurt function directly
func taken_damage(damage_just_taken: float):
	print("taken damage ", damage_just_taken)
	if damage_just_taken > 0:
		hitpoints -= damage_just_taken
		if damage_just_taken >= 2 and hitpoints > 0:
			$AnimatedSprite2D.play("hurt")
			hurting = true
		if hitpoints <= 0:
			$AnimatedSprite2D.play("die")
			dead = true

func attack(damage_outgoing: float):
	$Timer.stop()
	$AnimatedSprite2D.play("attack")
	attacking = true
	can_combo = true 
	await $AnimatedSprite2D.animation_finished
	$Timer.start(standardcombotime)
	print(can_combo)

func _on_timer_timeout():
	can_combo = false
	print(can_combo)

func _physics_process(delta):
	# Add the gravity.
	if not is_on_floor():
		velocity += get_gravity() * delta * 1.2
	if dead:
		return
	if !hurting:
		if Input.is_action_just_pressed("ui_accept") and is_on_floor():
			velocity.y = JUMP_VELOCITY
		if Input.is_action_just_pressed("selfhurt") and !Input.is_action_just_pressed("selfhurt_big"):
			taken_damage(1)
		if Input.is_action_just_pressed("selfhurt_big"):
			taken_damage(3.34)
		if Input.is_action_just_pressed("light") and !attacking:
			attack(5)
	
	# Get the input direction and handle the movement/deceleration.
	# As good practice, you should replace UI actions with custom gameplay actions.
	var direction = Input.get_axis("ui_left", "ui_right")
	if !$AnimatedSprite2D.is_playing() and (attacking or hurting):
		hurting = false
		attacking = false
		$AnimatedSprite2D.play("idle")
	if direction and !dead and !attacking and !hurting:
		$AnimatedSprite2D.play("walk")
		velocity.x = direction * SPEED
	else:
		velocity.x = move_toward(velocity.x, 0, SPEED)
		if !hurting and !dead and !attacking:
			$AnimatedSprite2D.play("idle")

	move_and_slide()
